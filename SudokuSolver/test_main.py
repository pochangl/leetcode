import copy
from itertools import product
from unittest import TestCase
from .main import Solution


class TestSolution(TestCase):
    def check_board(self, initial, board):
        for x, y in product(range(9), repeat=2):
            value = board[x][y]
            self.assertNotEqual(value, '.')

            # 檢查axis
            for index in range(9):
                if index != x:
                    self.assertNotEqual(board[index][y], value)
                if index != y:
                    self.assertNotEqual(board[x][index], value)

            # 檢查 block
            base_x = (x // 3) * 3
            base_y = (y // 3) * 3
            for dx, dy in product(range(3), repeat=2):
                target_x = base_x + dx
                target_y = base_y + dy
                if x != target_x or y != target_y:
                    self.assertNotEqual(board[target_x][target_y], value)

            for row1, row2 in zip(initial, board):
                for init, value in zip(row1, row2):
                    if init != '.':
                        self.assertEqual(init, value)

    def run_test(self, initial, expect):
        data = copy.deepcopy(initial)
        Solution().solveSudoku(data)
        self.assertEqual(data, expect)
        self.check_board(initial=initial, board=data)

    def test_case(self):
        '''
            test case from problem
        '''
        data = [
            ['5', '3', '.', '.', '7', '.', '.', '.', '.'],
            ['6', '.', '.', '1', '9', '5', '.', '.', '.'],
            ['.', '9', '8', '.', '.', '.', '.', '6', '.'],
            ['8', '.', '.', '.', '6', '.', '.', '.', '3'],
            ['4', '.', '.', '8', '.', '3', '.', '.', '1'],
            ['7', '.', '.', '.', '2', '.', '.', '.', '6'],
            ['.', '6', '.', '.', '.', '.', '2', '8', '.'],
            ['.', '.', '.', '4', '1', '9', '.', '.', '5'],
            ['.', '.', '.', '.', '8', '.', '.', '7', '9'],
        ]
        expect = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '7', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]

        self.run_test(data, expect)

    def test_case1(self):
        '''
        簡單的 case
        '''
        data = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '.', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]
        expect = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '7', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]

        self.run_test(data, expect)

    def test_case2(self):
        '''
        橫向簡單的case
        '''
        data = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['.', '.', '.', '.', '.', '.', '.', '.', '.'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]
        expect = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '7', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]

        self.run_test(data, expect)

    def test_case3(self):
        '''
        縱向簡單的case
        '''
        data = [
            ['5', '.', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '.', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '.', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '.', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '.', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '.', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '.', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '.', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '.', '5', '2', '8', '6', '1', '7', '9'],
        ]

        expect = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '7', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]

        self.run_test(data, expect)

    def test_case4(self):
        '''
            測單區塊
        '''
        data = [
            ['.', '.', '.', '6', '7', '8', '9', '1', '2'],
            ['.', '.', '.', '1', '9', '5', '3', '4', '8'],
            ['.', '.', '.', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]
        expect = [
            ['5', '3', '4', '6', '7', '8', '9', '1', '2'],
            ['6', '7', '2', '1', '9', '5', '3', '4', '8'],
            ['1', '9', '8', '3', '4', '2', '5', '6', '7'],
            ['8', '5', '9', '7', '6', '1', '4', '2', '3'],
            ['4', '2', '6', '8', '5', '3', '7', '9', '1'],
            ['7', '1', '3', '9', '2', '4', '8', '5', '6'],
            ['9', '6', '1', '5', '3', '7', '2', '8', '4'],
            ['2', '8', '7', '4', '1', '9', '6', '3', '5'],
            ['3', '4', '5', '2', '8', '6', '1', '7', '9'],
        ]

        self.run_test(data, expect)

    def test_case_hardest(self):
        '''
            source: https://www.conceptispuzzles.com/index.aspx?uri=info/article/424
        '''
        data = [
            ['8', '.', '.', '.', '.', '.', '.', '.', '.'],
            ['.', '.', '3', '6', '.', '.', '.', '.', '.'],
            ['.', '7', '.', '.', '9', '.', '2', '.', '.'],
            ['.', '5', '.', '.', '.', '7', '.', '.', '.'],
            ['.', '.', '.', '.', '4', '5', '7', '.', '.'],
            ['.', '.', '.', '1', '.', '.', '.', '3', '.'],
            ['.', '.', '1', '.', '.', '.', '.', '6', '8'],
            ['.', '.', '8', '5', '.', '.', '.', '1', '.'],
            ['.', '9', '.', '.', '.', '.', '4', '.', '.'],
        ]
        initial = copy.deepcopy(data)
        Solution().solveSudoku(data)
        for row in data:
            for column in row:
                self.assertNotEqual(column, '.', data)

        self.checkboard(initial=initial, board=data)

    def test_case_hardest_local1(self):
        '''
            有點難.
            第一個困難點在於所有格子都有 2 種以上的可能性
            唯一一個有2種可能性的格子在最右下角 4 的上面那格, 也就是 data[6][7] 的位置
                這格答案是 9, 理由是因為如果是 3 的話, 9 就沒位置放了
        '''
        data = [
            ['8', '.', '.', '.', '.', '.', '.', '.', '.'],
            ['.', '.', '3', '6', '.', '.', '.', '.', '.'],
            ['.', '7', '.', '.', '9', '.', '2', '.', '.'],
            ['.', '5', '.', '.', '.', '7', '.', '.', '.'],
            ['.', '.', '.', '.', '4', '5', '7', '.', '.'],
            ['.', '.', '.', '1', '.', '.', '.', '3', '.'],
            ['.', '.', '1', '.', '.', '.', '.', '6', '8'],
            ['.', '.', '8', '5', '.', '.', '.', '1', '.'],
            ['.', '9', '.', '.', '.', '.', '4', '.', '.'],
        ]
        Solution().solveSudoku(data)
        self.assertEqual(data[6][7], 9)
